//! In this benchmark we compare our `modular_bitfield` crate generated bitfields
//! with the ones generated by the popular `bitfield` crate.
//!
//! We want to find out which crate produces the more efficient code for different
//! use cases and scenarios.

mod utils;

use bitfield::bitfield as bitfield_crate;
use modular_bitfield::prelude::*;
use utils::*;

bitfield_crate! {
    pub struct OtherBitfield(u32);

    #[inline]
    pub a, set_a: 8, 0;
    #[inline]
    pub b, set_b: 14, 9;
    #[inline]
    pub c, set_c: 27, 15;
    #[inline]
    pub d, set_d: 28, 28;
    #[inline]
    pub e, set_e: 31, 29;
}

#[bitfield]
pub struct ModularBitfield {
    pub a: B9,
    pub b: B6,
    pub c: B13,
    pub d: B1,
    pub e: B3,
}

macro_rules! generate_cmp_benchmark_for {
    (
        test($test_name_get:ident, $test_name_set:ident) {
            fn $fn_get:ident($name_get:literal);
            fn $fn_set:ident($name_set:literal);
        }
    ) => {
        fn $test_name_get() {
            println!();
            compare(
                $name_get,
                || OtherBitfield(0),
                |input| {
                    repeat(|| {
                        black_box(input.$fn_get());
                    });
                },
            );
            compare($name_get, &ModularBitfield::new, |input| {
                repeat(|| {
                    black_box(input.$fn_get());
                });
            });
        }

        fn $test_name_set() {
            println!();
            compare(
                $name_set,
                || OtherBitfield(0),
                |mut input| {
                    repeat(|| {
                        black_box(black_box(&mut input).$fn_set(1));
                    });
                },
            );
            compare($name_set, &ModularBitfield::new, |mut input| {
                repeat(|| {
                    black_box(black_box(&mut input).$fn_set(1));
                });
            });
        }
    };
}
generate_cmp_benchmark_for!(
    test(bench_get_a, bench_set_a) {
        fn a("bitfield vs modular-bitfield - get_a");
        fn set_a("bitfield vs modular-bitfield - set_a");
    }
);
generate_cmp_benchmark_for!(
    test(bench_get_b, bench_set_b) {
        fn b("bitfield vs modular-bitfield - get_b");
        fn set_b("bitfield vs modular-bitfield - set_b");
    }
);
generate_cmp_benchmark_for!(
    test(bench_get_c, bench_set_c) {
        fn c("bitfield vs modular-bitfield - get_c");
        fn set_c("bitfield vs modular-bitfield - set_c");
    }
);
generate_cmp_benchmark_for!(
    test(bench_get_d, bench_set_d) {
        fn d("bitfield vs modular-bitfield - get_d");
        fn set_d("bitfield vs modular-bitfield - set_d");
    }
);
generate_cmp_benchmark_for!(
    test(bench_get_e, bench_set_e) {
        fn e("bitfield vs modular-bitfield - get_e");
        fn set_e("bitfield vs modular-bitfield - set_e");
    }
);

fn main() {
    bench_get_a();
    bench_get_b();
    bench_get_c();
    bench_get_d();
    bench_get_e();
    bench_set_a();
    bench_set_b();
    bench_set_c();
    bench_set_d();
    bench_set_e();
}
